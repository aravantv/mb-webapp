<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Elm â€¢ TodoMVC</title>
    <script type="text/javascript" src="main.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
</body>

<script type="text/javascript">
    // Applies the function [f] deep in [obj]. [f] takes as input an object and a field on this object.
    function applyDeep(path, f, obj, deepObjectShouldBeArray) {
        path.splice(0, 0, "root");
        var result = obj;
        for (var i = 0, n = path.length; i < n && result !== undefined; i++) {
            var field = path[i];
            if (i === n - 1) {
                f(result, field);
            } else {
                if (typeof result[field] !== 'object') {
                  if (i === n - 2 && deepObjectShouldBeArray) {
                    result[field] = [];
                  } else {
                    result[field] = {};
                  }
                }
                result = result[field];
            }
        }
    }

    function setValue(path, val, obj) {
        applyDeep(path, function (o, f) { o[f] = val; }, obj, false);
    }

    // [path] must have the form x.x.x.n where x.x.x points to an array and n is a number
    function insertValue(path, val, obj) {
        applyDeep(path, function (o, i) {
          // In case the object is empty, we need to initialize to ensure it is an array
          if (JSON.stringify(o) === JSON.stringify({})) {
            o[i] = val;
          } else {
            o.splice(i, 0, val);
          }
        }, obj, true);
    }

    // [path] must have the form x.x.x.n where x.x.x points to an array and n is a number
    function removeValue(path, obj) {
        applyDeep(path, function (o, i) { o.splice(i, 1); }, obj, true);
    }

    function sendAll(obj, currentPath) {
        for (var property in obj) {
            if (obj.hasOwnProperty(property)) {
                var newPath = currentPath.slice();
                newPath.push(property);
                if (typeof obj[property] === 'string') {
                    newPath.splice(0, 1);
                    mbwebapp.ports.getStringSub.send([newPath, obj[property]]);
                } else if (typeof obj[property] === 'object') {
                    sendAll(obj[property], newPath);
                    newPath.splice(0, 1);
                    mbwebapp.ports.itemAddedSub.send([newPath]);
                }
            }
        }
    }

    var serializedState = localStorage.getItem('localStorageResourceMBWebapp');
    var state = serializedState ? JSON.parse(serializedState) : {};
    // TODO remove this when everything works
    state = {}
    var mbwebapp = Elm.Main.fullscreen();

    sendAll(state, []);

    mbwebapp.ports.setStringCmd.subscribe(function (args) {
        setValue(args[0], args[1], state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.getStringSub.send(args);
    })

    mbwebapp.ports.addItemCmd.subscribe(function (args) {
        insertValue(args, null, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.itemAddedSub.send(args);
    });

    mbwebapp.ports.removeItemCmd.subscribe(function (args) {
        removeValue(args, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.itemRemovedSub.send(path);
    });
</script>

</html>
