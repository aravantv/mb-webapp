<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Elm â€¢ Model-based Web App</title>
    <script type="text/javascript" src="main.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
</body>

<script type="text/javascript">
    // Applies the function [f] deep in [obj]. [f] takes as input an object and a field on this object.
    function applyDeep(path, obj, deepObjectShouldBeArray, f) {
        var sanitizedPath = path.slice();
        sanitizedPath.splice(0, 0, "root");
        var result = obj;
        for (var i = 0, n = sanitizedPath.length; i < n && result !== undefined; i++) {
            var field = sanitizedPath[i];
            if (i === n - 1) {
                f(result, field);
            } else {
                if (typeof result[field] !== 'object') {
                  if (i === n - 2 && deepObjectShouldBeArray) {
                    result[field] = [];
                  } else {
                    result[field] = {};
                  }
                }
                result = result[field];
            }
        }
    }

    function setValue(path, val, obj) {
        applyDeep(path, obj, false, function (o, f) { o[f] = val; });
    }

    // [path] must have the form x.x.x.n where x.x.x points to an array and n is a number
    function insertValue(path, val, obj) {
        applyDeep(path, obj, true, function (o, i) {
          // In case the object is empty, we need to initialize to ensure it is an array
          if (JSON.stringify(o) === JSON.stringify({})) {
            o[i] = val;
          } else {
            o.splice(i, 0, val);
          }
        });
    }

    // [path] must have the form x.x.x.n where x.x.x points to an array and n is a number
    function removeValue(path, obj) {
        applyDeep(path, obj, true, function (o, i) { o.splice(i, 1); });
    }

    function sendValueAtPath(obj, path) {
      applyDeep(path, obj, false,
        function (o,f) {
          if (typeof o[f] === 'string') {
            mbwebapp.ports.getStringSubPort.send([path, o[f]]);
          } else if (Array.isArray(o[f])) {
            o[f].forEach(function(elt, i) {
              var elementPath = path.slice();
              elementPath.splice(0, 0, i.toString());
              mbwebapp.ports.itemAddedSubPort.send([elementPath, elt]);
            });
          }
        });
    }

    var serializedState = localStorage.getItem('localStorageResourceMBWebapp');
    var state = serializedState ? JSON.parse(serializedState) : {};
    var mbwebapp = Elm.Main.fullscreen();

    sendValueAtPath(state, []);

    mbwebapp.ports.askDataCmdPort.subscribe(function (args) {
        sendValueAtPath(state, args);
    })

    mbwebapp.ports.setStringCmdPort.subscribe(function (args) {
        var path = args[0]
        var value = args[1]
        setValue(path, value, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.getStringSubPort.send(args);
    })

    mbwebapp.ports.addItemCmdPort.subscribe(function (args) {
        var path = args[0]
        var value = args[1]
        insertValue(path, value, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));

        console.log("sending : " + path + " and:")
        console.log(value)
        mbwebapp.ports.itemAddedSubPort.send(args);
    });

    mbwebapp.ports.removeItemCmdPort.subscribe(function (path) {
        removeValue(path, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.itemRemovedSubPort.send(path);
    });
</script>

</html>
