<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Elm â€¢ Model-based Web App</title>
    <script type="text/javascript" src="main.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
</body>

<script type="text/javascript">

    function getShallowObject(id) {
      var serializedShallowObject = localStorage.getItem(id)
      return serializedShallowObject ? JSON.parse(serializedShallowObject) : 'ID NOT FOUND - please report'
    }

    // Follows the references to reconstitue a complete object.
    // If part of the object is already known, it can be provided as the second parameter.
    function reconstituteObject(shallowObject, knownID, knownValue) {
      if (typeof shallowObject === 'string') {
        return shallowObject
      } else if (typeof shallowObject === 'number') {
        return shallowObject
      } else if (typeof shallowObject === 'boolean') {
        return shallowObject
      } else if (typeof shallowObject === 'object') {
        if (Array.isArray(shallowObject)) {
          var result = []
          shallowObject.forEach(function(id) {
            result.push(id === knownID ? knownValue : reconstituteObject(getShallowObject(id)))
          })
          return result
        } else {
          Object.keys(shallowObject).forEach(function(key) {
            var id = shallowObject[key]
            shallowObject[key] = id === knownID ? knownValue : reconstituteObject(getShallowObject(id))
          });
          return shallowObject
        }
      }
    }

    var parentIDs = {}

    function isListened(id) {
      return parentIDs[id] != null
    }

    function addParentID(id, parentID) {
      if (!parentIDs[id]) {
        parentIDs[id] = []
      }
      if (parentID && parentIDs[id].indexOf(parentID) > -1) {
        parentIDs[id].push(parentID)
      }
    }

    function updateParentIDs(id, parentID) {
      // must be computed before the call to [addParentID]
      var alreadyPresent = parentID ? false : parentIDs[id].indexOf(parentID) == -1

      if (parentID) {
        addParentID(id, parentID)
      } else {
        parentIDs[id] = []
      }

      // The following condition is there to prevent potential infinite loops
      if (!(parentID && alreadyPresent)) {
        var valueAtId = JSON.parse(localStorage.getItem(id))
        if (typeof obj === 'object') {
          if (Array.isArray(valueAtId)) {
            valueAtId.forEach(function (subId) {
              updateParentIDs(subId, id)
            })
          } else {
            Object.keys(obj).forEach(function (key) {
              updateParentIDs(obj[key], id)
            }
          }
        }
      }
    }

    function createNewID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8)
        return v.toString(16)
      });
    }

    function flattenObject(obj, parentID) {
      if (typeof obj === 'string') {
        return obj
      } else if (typeof obj === 'number') {
        return obj
      } else if (typeof obj === 'boolean') {
        return obj
      } else if (typeof obj === 'object') {
        if (Array.isArray(obj)) {
          var result = []
          obj.forEach(function(x) {
            var xId = createNewID()
            var shallowX = flattenObject(x, parentID ? xId : null)
            if (parentID) {
              addParentID(xId, parentID)
            }
            localStorage.setItem(xId, JSON.stringify(shallowX))
            result.push(xId)
          })
        } else {
          var result = {}
          Object.keys(obj).forEach(function(key) {
            var keyId = createNewID()
            var shallowObjKey = flattenObject(obj[key], parentID ? keyId : null)
            if (parentID) {
              addParentID(keyId, parentID)
            }
            localStorage.setItem(keyId, JSON.stringify(shallowObjKey))
            result[key] = keyId
          })
          return result
        }
      }
    }

    var serializedState = localStorage.getItem('MBWebappRoot')
    var state = serializedState ? JSON.parse(serializedState) : {}
    var mbwebapp = Elm.Main.fullscreen()

    mbwebapp.ports.subscribeCmdPort.subscribe(function(id) {
      updateParentIDs(id, null)
    })

    mbwebapp.ports.askDataCmdPort.subscribe(function (id) {
      var shallowObj = getShallowObject(id)
      mbwebapp.ports.getDataSubPort.send([id, shallowObj, reconstituteObject(shallowObj)])
    })

    function informParents(id, knownValue) {
      var alreadySeenIDs = []
      informParentsWithoutCycle(id,knownValue)
      function informParentsWithoutCycle(id, knownValue) {
        if (parentIDs[id] && alreadySeenIDs.indexOf(id) === -1) {
          alreadySeenIDs.push(id)
          var value = knownValue ? knownValue : reconstituteObject(getShallowObject(id))
          parentIDs[id].forEach(function(parentID) {
            var parentValue = reconstituteObject(parentID, id, value)
            var shallowParentValue = getShallowObject(parentID)
            mbwebapp.ports.getDataSubPort.send([parentID, shallowParentValue, parentValue])
            informParents(parentID, parentValue)
          })
        }
      }
    }

    mbwebapp.ports.setDataCmdPort.subscribe(function (args) {
        var id = args[0]
        var value = args[1]
        var shallowValue = flattenObject(value, isListened(id) ? id : null)
        localStorage.setItem(id, JSON.stringify(shallowValue))
        mbwebapp.ports.getDataSubPort.send([id, shallowValue, value])
        informParents(id, value)
    })

    mbwebapp.ports.addItemCmdPort.subscribe(function (args) {
        var id = args[0]
        var index = args[1]
        var valueAtId = JSON.parse(localStorage.getItem(id))
        if (typeof valueAtId !== 'object' || !(Array.isArray(valueAtId))) {
          console.log("ERROR: Request to add an item to a non-array data (id: " + id + ")")
        } else {
          var value = args[2]
          var valueId = createNewID()
          var shallowValue = flattenObject(value, isListened(id) ? valueId : null)
          addParentID(valueId, id)
          localStorage.setItem(valueId, JSON.stringify(shallowValue))
          valueAtId.splice(index, 0, valueId)
          localStorage.setItem(id, JSON.stringify(valueAtId))
          mbwebapp.ports.itemAddedSubPort.send([id, index, value, valueId])
          informParents(valueId, value)
        }
    })

    mbwebapp.ports.removeItemCmdPort.subscribe(function (args) {
      var id = args[0]
      var index = args[1]
      var valueAtId = JSON.parse(localStorage.getItem(id))
      if (typeof valueAtId !== 'object' || !(Array.isArray(valueAtId))) {
        console.log("ERROR: Request to add an item to a non-array data (id: " + id + ")")
      } else {
        valueAtId.splice(index,1)
        localStorage.setItem(id, JSON.stringify(valueAtId))
        mbwebapp.ports.itemRemovedSubPort.send([id, index])
        informParents(id, null)
      }
    })
</script>

</html>
