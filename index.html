<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Elm â€¢ TodoMVC</title>
    <script type="text/javascript" src="main.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
</body>

<script type="text/javascript">
    // Applies the function [f] deep in [obj]. [f] takes as input an object and a field on this object.
    function applyDeep(path, f, obj, deepObjectShouldBeArray) {
        path.splice(0, 0, "root");
        var result = obj;
        for (var i = 0, n = path.length; i < n && result !== undefined; i++) {
            var field = path[i];
            if (i === n - 1) {
                f(result, field);
            } else {
                if (typeof result[field] !== 'object') {
                  if (i === n - 2 && deepObjectShouldBeArray) {
                    result[field] = [];
                  } else {
                    result[field] = {};
                  }
                }
                result = result[field];
            }
        }
    }

    function setValue(path, val, obj) {
        applyDeep(path, function (o, f) { o[f] = val; }, obj, false);
    }

    // [path] must have the form x.x.x.n where x.x.x points to an array and n is a number
    function insertValue(path, val, obj) {
        applyDeep(path, function (o, i) {
          // In case the object is empty, we need to initialize to ensure it is an array
          if (JSON.stringify(o) === JSON.stringify({})) {
            o[i] = val;
          } else {
            o.splice(i, 0, val);
          }
        }, obj, true);
    }

    // [path] must have the form x.x.x.n where x.x.x points to an array and n is a number
    function removeValue(path, obj) {
        applyDeep(path, function (o, i) { o.splice(i, 1); }, obj, true);
    }

    function sendAll(obj, currentPath) {
      if (typeof obj === 'string') {
        mbwebapp.ports.getStringSubPort.send([currentPath, obj]);
      } else if (Array.isArray(obj)) {
        obj.forEach(function(elt, i) {
          var newPath = currentPath.slice();
          newPath.splice(0, 0, i.toString());
          mbwebapp.ports.itemAddedSubPort.send(newPath);
          sendAll(obj[i], newPath);
        })
      }
    }

    var serializedState = localStorage.getItem('localStorageResourceMBWebapp');
    var state = serializedState ? JSON.parse(serializedState) : {};
    var mbwebapp = Elm.Main.fullscreen();

    sendAll(state.root, []);

    mbwebapp.ports.setStringCmdPort.subscribe(function (args) {
        setValue(args[0], args[1], state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.getStringSubPort.send(args);
    })

    mbwebapp.ports.addItemCmdPort.subscribe(function (args) {
        insertValue(args, null, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.itemAddedSubPort.send(args);
    });

    mbwebapp.ports.removeItemCmdPort.subscribe(function (args) {
        removeValue(args, state);
        localStorage.setItem('localStorageResourceMBWebapp', JSON.stringify(state));
        mbwebapp.ports.itemRemovedSubPort.send(path);
    });
</script>

</html>
